{{ define "title" }}
  Pkgs on Nix: Curated information about every package on Nix!
{{ end }}

{{ define "nav-title"}}
  Pkgs on Nix
{{ end }}

{{ define "nav-subtitle"}}
  Curated information about every package on Nix!
{{ end }}

{{ define "main" }}
  {{ $count := 0 }}
  {{ range $set, $_ := $.Site.Data }}
    {{ range $attr, $_ := index $.Site.Data $set }}
      {{ $count = add $count 1 }}
    {{ end }}
  {{ end }}

  <div class="pa2">
    <span class="db pa2">ðŸ”Ž Search from {{ $count }} packages available</span>
    <input
      autofocus
      class="ba b--cyan ma0 pa2 outline-transparent w-100"
      id="search-input"
      placeholder="Type something to get started"
      type="text"
    >
  </div>
  <div class="pv1"></div>
  <div class="pa2" id="search-instructions">
    Some search examples:

    <ul>
      <li><span class="blue">firefox</span>: Search packages similar to firefox</li>
      <li><span class="blue">=docker</span>: Search for an exact match</li>
      <li><span class="blue">!linux</span>: Exclude linux from the results</li>
      <li><span class="blue">^python</span>: Search packages starting with Python</li>
      <li><span class="blue">rust$</span>: Search packages ending with Rust</li>
    </ul>

    Search is case insensitive.
  </div>
  <div id="search-results"></div>

  <div style="display: none">
    {{ range $set, $_ := $.Site.Data }}
      {{ range $attr, $_ := index $.Site.Data $set }}
        <p class="ma1" id="{{ $set }}-{{ $attr }}">
          <dfn class="b fs-normal">
            <a class="b blue" href="/nixpkgs/{{ lower $attr }}/">
              nixpkgs / {{ $attr }}
            </a>
          </dfn>
          {{ $data := index $.Site.Data $set $attr }}
          {{ if $data.meta.desc }}
            - {{ $data.meta.desc }}
          {{ end }}
        </p>
      {{ end }}
    {{ end }}
  </div>

  <script src="https://unpkg.com/fuse.js@6.4.6/dist/fuse.min.js"></script>
  <script>
    const searchEngineIndex = [
      {{ range $set, $_ := $.Site.Data }}
        {{ range $attr, $_ := index $.Site.Data $set }}
          {{ $data := index $.Site.Data $set $attr }}
            {
              "set": "{{ $set }}",
              "attr": "{{ $attr }}",
              "desc": "{{ $data.meta.desc }}",
            },
        {{ end }}
      {{ end }}
    ];

    const searchInput = document.querySelector("#search-input");

    searchInput.addEventListener('input', search);

    function search() {
      const results = new Fuse(searchEngineIndex, {
        keys: [
          { name: 'attr', weight: 10},
          { name: 'desc', weight: 1},
        ],
        ignoreLocation: true,
        minMatchCharLength: 0,
        useExtendedSearch: true,
      }).search(searchInput.value.toLowerCase()).slice(0, 100);

      const searchInstructions = document.querySelector('#search-instructions');
      const searchResults = document.querySelector('#search-results');

      if (results.length == 0) {
        searchInstructions.style.display = ""
        searchResults.style.display = "none"
      } else {
        searchResults.innerHTML = '';
        searchInstructions.style.display = "none"
        searchResults.style.display = ""
        results.map((result) => {
          const element = document.querySelector(`p[id='${result.item.set}-${result.item.attr}']`);
          searchResults.appendChild(element.cloneNode(true));
        });
      };
    };

    search();
  </script>
{{ end }}
